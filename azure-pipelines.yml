# Azure build pipelines for Sysmon

trigger:
    branches:
      include:
        - release/*
        - main
      exclude:
        - dev/*
        - test/*
  
pr:
- main

jobs:
  - job: "Build_Sysmon"
    pool: "Sysmon-Ubuntu-20.04-Pool"
    steps:
    - checkout: self
      submodules: true
    - script: |
        wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
        dpkg -i packages-microsoft-prod.deb
        apt -y update
        apt install sysinternalsebpf
        mkdir build && cd build
        cmake ..
        make
        apt remove -y sysinternalsebpf
      displayName: "Build Sysmon Binary"
  
  - job: "Sysmon_Package_Build"
    pool: "Sysmon-Ubuntu-20.04-Pool"
    condition: not(eq(variables['Build.Reason'], 'PullRequest'))
    dependsOn:
      - "Build_Sysmon"
    steps:
    - checkout: self
      submodules: true
    - script: |
        wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
        dpkg -i packages-microsoft-prod.deb
        apt -y update
        apt install sysinternalsebpf
        mkdir build && cd build
        cmake ..
        make
      displayName: "Build Sysmon Binary"
    
    - script: |
        cd build
        make packages
      displayName: "Build Sysmon Package"
    
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/build/deb/'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/Ubuntu/'
      displayName: 'Copy build artifacts to staging'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

# CentOS build and package
  - job: "Build_Sysmon"
    pool: "Sysmon-CentOS-8-Pool"
    steps:
    - checkout: self
      submodules: true
    - script: |
        yum install sysinternalsebpf
        mkdir build && cd build
        cmake ..
        make
        yum remove sysinternalsebpf
      displayName: "Build Sysmon Binary"
  
  - job: "Sysmon_Package_Build"
    pool: "Sysmon-CentOS-8-Pool"
    condition: not(eq(variables['Build.Reason'], 'PullRequest'))
    dependsOn:
      - "Build_Sysmon"
    steps:
    - checkout: self
      submodules: true
    - script: |
        yum install sysinternalsebpf
        mkdir build && cd build
        cmake ..
        make
      displayName: "Build Sysmon Binary"
    
    - script: |
        cd build
        make packages
      displayName: "Build Sysmon Package"
    
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/build/rpm/'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/CentOS/'
      displayName: 'Copy build artifacts to staging'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'